cmake_minimum_required(VERSION 2.8)

project(qstem)

#set(CMAKE_SHARED_LINKER_FLAGS "-Wl,--export-all-symbols")
#set(CMAKE_SHARED_LINKER_FLAGS "-Wl")
#SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC" )

if (WIN32)
  set(Boost_USE_STATIC_LIBS ON)
endif(WIN32)

set(_SAVED_HDF5_DIR ${HDF5_DIR})

FIND_PACKAGE(HDF5 "1.8.5" NO_MODULE)  # First look for hdf5-config.cmake in defined locations. This file is generated by HDF5 team and is likely more up to date than FindHDF5.cmake included in CMake.
IF(NOT HDF5_FOUND)
	# didn't find hdf5-config.cmake.  Need to fall back on CMake's built-in FindHDF5.cmake logic.
	# required says we fail if it isn't found.
	# Restore the value reset by the previous call to 'find_package(HDF5 "1.8.5" NO_MODULE)'
	set(HDF5_DIR ${_SAVED_HDF5_DIR} CACHE PATH "HDF5 install dir" FORCE)
	FIND_PACKAGE(HDF5 "1.8.5" REQUIRED)
ENDIF()

find_package(Boost 1.49.0 COMPONENTS filesystem system REQUIRED)

FILE(GLOB LIBS_FILES "*.?pp")

function (add_lib_dir dirname)
	#add_subdirectory(${dirname})
        #exploring this: not ideal to use glob because it defeats some of CMake's ability to detect changes
        #  a better way would be to manually add files in CMakeLists.txt in each folder (still adding them ultimately
        #  to LIBS_FILES
	FILE(GLOB TMP "${dirname}/*.?pp")
	set(LIBS_FILES ${LIBS_FILES} ${TMP} PARENT_SCOPE)
	SOURCE_GROUP(${dirname} FILES ${TMP} PARENT_SCOPE)
endfunction(add_lib_dir)

# defines qstem_config (config readers)
add_lib_dir(config_IO)
# defines qstem_data (I/O for image data)
add_lib_dir(data_IO)
#defines qstem_structure
add_lib_dir(structure_IO)
# defines qstem_wavefunctions
add_lib_dir(wavefunctions)
# defines qstem_potentials
add_lib_dir(potentials)
# defines qstem_experiments
add_lib_dir(experiments)

include_directories(
  ${PROJECT_SOURCE_DIR}
  config_IO
  data_IO
  structure_IO
  wavefunctions
  potentials
  experiments
  ${Boost_INCLUDE_DIRS} 
  ${FFTW3_INCLUDE_DIRS} 
  ${HDF5_INCLUDE_DIR}  )

add_library(${PROJECT_NAME} SHARED ${LIBS_FILES})
target_link_libraries(${PROJECT_NAME} ${Boost_LIBRARIES} ${HDF5_LIBRARIES} ${FFTW3F_LIBS} ${FFTW3_LIBS})

if(OPENMP)
  SET_TARGET_PROPERTIES(${PROJECT_NAME} PROPERTIES COMPILE_FLAGS "${OpenMP_C_FLAGS}" LINK_FLAGS  "${OpenMP_C_FLAGS}")
endif(OPENMP)
